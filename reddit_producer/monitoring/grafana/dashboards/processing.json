{
  "__inputs": [],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "9.0.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "1.0.0" }
  ],
  "annotations": { "list": [] },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "title": "Messages Consumed / sec",
      "type": "timeseries",
      "id": 1,
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "rate(reddit_processor_messages_total[1m])",
          "legendFormat": "{{topic}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "color": { "mode": "palette-classic" }
        }
      }
    },
    {
      "title": "Batch Flush Latency (P50 / P95 / P99)",
      "type": "timeseries",
      "id": 2,
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "reddit_processor_batch_flush_seconds{quantile=\"0.5\"}",
          "legendFormat": "P50"
        },
        {
          "datasource": "Prometheus",
          "expr": "reddit_processor_batch_flush_seconds{quantile=\"0.95\"}",
          "legendFormat": "P95"
        },
        {
          "datasource": "Prometheus",
          "expr": "reddit_processor_batch_flush_seconds{quantile=\"0.99\"}",
          "legendFormat": "P99"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s" }
      }
    },
    {
      "title": "Batch Outcomes (ok vs error per min)",
      "type": "timeseries",
      "id": 3,
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "rate(reddit_processor_batches_total[1m])",
          "legendFormat": "{{status}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "reqps" },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "error" },
            "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }]
          }
        ]
      }
    },
    {
      "title": "DLQ Messages / sec",
      "type": "timeseries",
      "id": 4,
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "rate(reddit_processor_dlq_messages_total[1m])",
          "legendFormat": "DLQ rate"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "color": { "fixedColor": "orange", "mode": "fixed" }
        }
      }
    },
    {
      "title": "Total DLQ Messages (ever)",
      "type": "stat",
      "id": 5,
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 16 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "reddit_processor_dlq_messages_total",
          "legendFormat": "DLQ total"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 10 },
              { "color": "red", "value": 100 }
            ]
          }
        }
      }
    },
    {
      "title": "Batch Flush Latency P99 (last 5m)",
      "type": "stat",
      "id": 6,
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 16 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "reddit_processor_batch_flush_seconds{quantile=\"0.99\"}",
          "legendFormat": "P99 flush"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 0.5 },
              { "color": "red", "value": 2.0 }
            ]
          }
        }
      }
    },
    {
      "title": "Velocity Cache Size",
      "type": "stat",
      "id": 7,
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 16 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "reddit_processor_velocity_cache_size",
          "legendFormat": "cache entries"
        }
      ]
    },
    {
      "title": "DB Pool Available Connections",
      "type": "gauge",
      "id": 8,
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 16 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "reddit_processor_db_pool_available",
          "legendFormat": "available"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "min": 0,
          "max": 20,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 3 },
              { "color": "green", "value": 8 }
            ]
          }
        }
      }
    }
  ],
  "refresh": "30s",
  "schemaVersion": 37,
  "style": "dark",
  "tags": ["reddit-pulse", "processing"],
  "templating": { "list": [] },
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "timezone": "browser",
  "title": "Reddit Pulse â€” Processing Pipeline",
  "uid": "reddit-processing",
  "version": 1
}
